# HTTP性能优化

* HTTPS 强化通信链路安全

* HTTP/2 优化传输效率

* Nginx/OpenResty 提升网站服务能力

* WAF 抵御网站入侵攻击
* CND 网络加速



## 性能度量指标

### 服务端指标

* **吞吐量RPS（requests per second）**、TPS、QPS：表示网络接口**接收和传输的每秒字节数**。是服务器的基本指标，RPS越高性能越好。
* **并发数（concurrency）**：表示**服务器的负载能力**，能同时支持多少客户端。也是越大越好。
* **响应时间（time per request）**：表示**服务器的处理能力**。响应时间越短越好，越低说明就能服务更多的客户端，吞吐量和并发数也就越高。
* **资源占用率**：例如CPU、内存、硬盘和网卡的占用率。太高或太低都可能存在问题，需要在一个合理的区间。

### 客户端指标

* **延迟（latency）**：客户端等待数据响应的耗时。
  * 系统调用发送/接收延时
  * 连接延时：TCP握手
  * 首包延时
  * 网络往返时间。

### 错误

丢包计数、超时等。



## 检测工具

### Linux下工具

* ab（Apache Bench）：Linux下常用的性能检测工具。

  ```shell
  # 并发：100
  # 次数：10000
  # 目标：`http://www.xxx.com`
  ab -c 100 -n 10000 'http://www.xxx.com'
  ```

* 资源监控：top、vmstat、netstat、sar等

  ```shell
  top             #查看CPU和内存占用情况
  vmstat  2       #每2秒检查一次系统状态
  sar -n DEV 2    #看所有网卡的流量，定时2秒检查
  ```



### 测试网站

https://www.webpagetest.org/

### 浏览器自带的开发工具



## HTTP耗时原因

* **队头阻塞**：队头阻塞导致的排队时间。
* **资源分配**：客户端（浏览器）预先分配资源，调度连接。
* **域名解析**。
* **TCP握手**。
* **TLS的握手**：非对称加密握手。
  * 网络：TLS握手需要发送往返消息。
  * ECDHE临时密钥的生成。
  * 证书的验证。
  * 加解密 `Pre-Master`。
* **报文的加解密**：报文传输过程需要使用对称加密（AES）来加解密，存在一定的损耗。不过这些算法性能都比较优秀且存在硬件加速，**损耗可以忽略不记**。 
* **数据发送**：复杂的网络结构、地理位置间的距离。
* **等待响应**。

## 两端优化方向

* **硬件优化**：主要是计算密集型，可以考虑服务端CPU升级、使用SSL加速服务器等手段进行优化。

* **软件优化**：在硬件不升级的情况下提高性能。Linux内核升级、Nginx/OpenResty升级等。

* **协议优化**：使用TLS1.3、选用ECDHE 椭圆曲线密码套件。

* **证书优化**：尽量选用椭圆曲线（ECDSA）证书，位数比RSA更小可以节约带宽和计算量。

  * 服务端开启`OCSP Stapling`，由服务端来预先获取 OCSP响应。

* **会话复用（TLS session resumption）**：将在TLS握手过程中生成的 主密钥（Master Sercet）缓存复用。

  * ~~`Session ID(TLS1.3已废弃)`~~：连接后服务端和客户端各自保存一个ID，下次新建立连接时将ID发送过去，ID存在就直接用内存中缓存的主密钥恢复会话，从而跳过了验证和密钥交换。（服务端必须保存每一个客户端的会话数据，体量大时负担很重）。

  * ~~`Session Ticket(TLS1.3已废弃)`~~：服务端发送 `New Session Ticket` 发送给 Session Ticket 给客户端，并**由客户端存储**，重连时客户端使用扩展字段 `session_ticket` 发送 `Ticket`，服务端解密验证，通过就恢复会话。

    ![image-20230212163812918](./HTTP%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.assets/image-20230212163812918.png)

    ![image-20230212163927395](./HTTP%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.assets/image-20230212163927395.png)

  * **PSK（预共享密钥,Pre-shared Key）**：TLS1.3中会话复用的实现方案，做到了0-RTT。可以认为是 `Session Ticket` 的升级版，原理就是 客户端在发送 Ticket 的同时带上数据，免去了服务端验证。存在重放攻击的问题。可以通过`SameSite=Strike`，限制仅允许GET/HEAD方法调用、增加时间戳等方式解决。

## 传输链路优化方向

更大的带宽、更多的运营商网络、CDN加速。

## 具体优化实施

* **选择高性能Web服务器**：如Nginx、OpenResty。
* **开启HTTP长连接**：降低TCP 和 SSL建立连接的成本。
* **数据压缩**：文本使用gzip、br压缩等，图片使用Webp、JPEG等。小文件采用资源合并（精灵图）的方式降低请求数，不过不利于缓存。
* **域名收缩**：减少DNS解析次数。
* **减少重定向**：重定向不仅会增加一次请求往返，还可能会导致DNS解析。
* **缓存**：网站内部可以使用Memcache、Redis等，外部则使用 CDN。
* **升级协议**：HTTP/2，需要实现域名收缩，少用资源合并。