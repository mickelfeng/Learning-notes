# 音视频基础

---

[TOC]

---

## 知识点

视频产生的大致流程：

摄像机个录音设备分别采集数据，然后将数据送入对应的编码器，将编码得到的音轨和视轨送入到合成器（FFmped等），最终合并成MP4文件。

![406204beab2de273ecdb436d4bf66773](./%E9%9F%B3%E8%A7%86%E9%A2%91%E5%9F%BA%E7%A1%80.assets/406204beab2de273ecdb436d4bf66773.webp)



| 基础概念     |                               |                    |
| ------------ | ----------------------------- | ------------------ |
| 音调（音频） | 低音：音频慢<br/>高音：音频快 |                    |
| 音量         | 振动的幅度                    |                    |
| 音色(音品)   | 和材质有关，本质是谐波        |                    |
| 音轨         |                               | AAC                |
| 视轨         |                               | H.265(HEVC)、H.264 |
|              |                               |                    |
|              |                               |                    |

### 视频格式

| 音频格式 |      |      |
| -------- | ---- | ---- |
| mp4      |      |      |
|          |      |      |
|          |      |      |

### 量化和编码

>  一段音频波形数据 -> 采样(分割波形) -> 量化(点) -> 编码(01) -> 数字信号

| 基础概念 |                                                    |                                                              |
| -------- | -------------------------------------------------- | ------------------------------------------------------------ |
| 码率     | 用于衡量压缩编码压缩后数据量的多少，越大数据量越多 | 计算一个PCM音频流的码率 :<br/><br/>采样率 * 采样大小 * 声道数 <br/>8K * 16bit * 2 = 256Kb/s = 32KB/s |
| 采样大小 | 一个采样用多少bit存放。常用16bit                   |                                                              |
| 采样率   | xHZ的音频每个正弦波的采样次数 = 采样率/xHZ         | 8K, 16K, 32K, 44.1K, 48K                                     |

### 音频的压缩

- 消除冗余数据
```
去除采集到的冗余数据 : 
- 人(20~20000)无法识别的的音频信号
- 被掩蔽掉的音频信号(频域遮蔽和时域遮蔽)
    - 频域遮蔽
    1. 音量很低的声音
    2. 当声音的频率相差很近时, 音量大的将会覆盖音量小的
    - 时域遮蔽
    先有一个音量相对小一些的声音，同时进来一个音量相对大的声音，经过一定时间(50ms)，相对小的将会被屏蔽。相对小的继续，相对大的停止，屏蔽效果也仍然持续一定时间(100ms) 
```

- 哈夫曼无损编码

### 音频编解码器

常见的 : OPUS、AAC、Vorbis、Speex、iLBC、AMR、G.711等

### H264编码原理

|                                |                      |                                        |
| ------------------------------ | -------------------- | -------------------------------------- |
| I帧                            | 关键帧,              | 保留帧的所有信息，解码时无需依赖其他帧 |
| P帧                            | 压缩帧               | 向前比较，依赖前面的帧                 |
| B帧                            | 压缩帧               | 前后双向比较，依赖前面和后面的帧。     |
| GOP                            | 两个关键帧之间的间隔 | 前一个I帧到后一个I帧                   |
| DTS（Decoding Time Stamp）     | 解码时间戳           | 告诉播放器该在什么时候解码这一帧的数据 |
| PTS（Presentation Time Stamp） | 显示时间戳           | 告诉播放器该在什么时候显示这一帧的数据 |
| SPS                            | 帧信息               |                                        |
| PPS                            | 图像信息             |                                        |

- 帧内压缩
- 帧间压缩

### NAL单元和码流结构

![NAL单元和码流结构](./%E9%9F%B3%E8%A7%86%E9%A2%91%E5%9F%BA%E7%A1%80.assets/image_1cei5f67b36fg48d341r5omv79.png)




### 直播

泛娱乐直播拓扑架构
实时直播拓扑架构



## 相关工具和项目

|               |                                 |                                                              |
| ------------- | ------------------------------- | ------------------------------------------------------------ |
| AtomicParsley | 检测一个 MP4 的 moov 是否在前面 |                                                              |
| ijkplayer     | 支持边下边播开源播放器          | [bilibili/ijkplayer: Android/iOS video player based on FFmpeg n3.4, with MediaCodec, VideoToolbox support. (github.com)](https://github.com/bilibili/ijkplayer) |
| ExoPlayer     | 支持边下边播开源播放器          | [google/ExoPlayer: An extensible media player for Android (github.com)](https://github.com/google/ExoPlayer) |



## 搭建一个本地的流媒体服务

- 服务器(Linuex), 本地使用的mac
- 编译安装Nginx服务
- 配置RTMP服务并启动nginx


### Mac上安装Nginx 和 rtmp

1. 安装
```shell
brew install nginx-full --with-rtmp-module
```

2. rtmp 服务配置
```properties
# 修改配置文件 /usr/local/etc/nginx/nginx.conf

# rtmp服务
rtmp{
    server {
        # 指定服务器端口
        listen:1992;
        # 传输块大小 4000字节
        chunk_size:4000;
        # 指定流应用
        application live {
            live on;
            record off;
            allow play all;
        }
    }
}
```

3. 启动nginx
```shell
- nginx
- nginx -s reload
- nginx -s stop
```

### ffmpeg 命令

推流：

```shell
ffmpeg -re -i out.mp4 -c copy -f flv rtmp://server/xxx/xxx
```

拉流：

```shell
ffmpeg -i rtmp://server/xxx/xxx -c copy dump.flv
```

其他命令：

```shell
# -movflags faststart：将moov提前放到文件头部
ffmpeg -i input.mp4 -movflags faststart -acodec copy -vcodec copy output.mp4
```



### 本地调试

- 找一个直播地址 拉流 到本机rtmp服务器
```shell
ffmpeg -i http://xxxxx -c:a copy -c:v copy -f flv rtmp://localhost:1992/live/room
```
- ffplay 播放
```shell
ffplay rtmp://localhost:1992/live/room
```

