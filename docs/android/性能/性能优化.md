# 性能优化

## I/O

> 磁盘I/O性能指标
>
> ``吞吐量``：连续读写速率。
> ``IOPS``：每秒读写的次数。

### 1. I/O测量方式

- proc

  ```
  # 观测I/O负载
  proc/self/schedstat:
    se.statistics.iowait_count：IO 等待的次数
    se.statistics.iowait_sum：  IO 等待的时间
  ```

  ```
  # root 下 开启I/O监控，将所有block读写dump到日志文件中
  echo 1 > /proc/sys/vm/block_dump
  dmesg -c grep pid
  
  .sample.io.test(7540): READ block 29262592 on dm-1 (256 sectors)
  .sample.io.test(7540): READ block 29262848 on dm-1 (256 sectors)
  ```

- strace

  ```shell
  # 跟踪I/O的系统调用次数和耗时
  strace -ttT -f -p [pid]
  
  # 文件操作符：53
  # 每次读取：1024字节
  # 读取时间：447us
  read(53, "*****************"\.\.\., 1024) = 1024       <0.000447>
  read(53, "*****************"\.\.\., 1024) = 1024       <0.000084>   // 页缓存
  read(53, "*****************"\.\.\., 1024) = 1024       <0.000059>
  ```

  ```shell
  # 统计一段时间内所有系统调用的耗时概况。
  strace -c -f -p [pid]
  
  % time     seconds  usecs/call     calls    errors  syscall
  ------ ----------- ----------- --------- --------- ----------------
   97.56    0.041002          21      1987             read
    1.44    0.000605          55        11             write
  ```

 - vmstat

   ```
   //清除Buffer和Cache内存缓存
   echo 3 > /proc/sys/vm/drop_caches
   //每隔1秒输出1组vmstat数据
   vmstat 1
   
   
   //测试写入速度，写入文件/data/data/test，buffer大小为4K，次数为1000次
   dd if=/dev/zero of=/data/data/test bs=4k count=1000
   ```



## 2. mmap

将文件映射到进程的地址空间。

- 减少系统调用。

  ```
  仅需要一次mmap()系统调用。省去了read/write系统调用。
  ```

- 减少数据拷贝。

  ```
  由于做过内存映射，不需要从内核空间拷贝到用户空间，仅需要执行一次磁盘拷贝。
  ```

- 可靠性高。

  ```
  mmap将数据写入到页缓存中。利用了页缓存机制。
  同样有延迟写机制和强制同步写。
  ```

- 会使虚拟内存增大，从而导致OOM。

- 磁盘延迟，mmap通过缺页中断向磁盘发起真正的磁盘I/O。